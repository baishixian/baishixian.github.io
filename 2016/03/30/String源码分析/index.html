<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>String源码分析 | Keep Thinking</title>
    <meta name="author" content="baishixian">
    
    <meta name="description" content="永远年轻，永远热泪盈眶">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="String源码分析"/>
    <meta property="og:site_name" content="Baishixian&#39;s Blog"/>

    
    <meta property="og:image" content="undefined"/>
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="Baishixian&#39;s Blog" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>


<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="brown darken-1">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class="">
            <a href="/" class="brand-logo hide-on-med-and-down">Baishixian&#39;s Blog</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/" >
                            <i class="fa fa-home "></i>
                            
                            首页
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives" >
                            <i class="fa fa-archive "></i>
                            
                            归档
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                            <i class="fa fa-bookmark "></i>
                            
                            分类
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-reading " href="/reading" >
                            <i class="fa fa-book "></i>
                            
                            读书
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about" >
                            <i class="fa fa-user "></i>
                            
                            关于
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search" >
                            <i class="fa fa-search "></i>
                            
                            搜索
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav brown darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="http://7xt7m8.com2.z0.glb.clouddn.com/header.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">baishixian</p>
                        <p class="desc">Android developer</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/" >
                    <i class="fa fa-home "></i>
                    
                    首页
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives" >
                    <i class="fa fa-archive "></i>
                    
                    归档
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu" >
                    <i class="fa fa-bookmark "></i>
                    
                    分类
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-reading " href="/reading" >
                    <i class="fa fa-book "></i>
                    
                    读书
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about" >
                    <i class="fa fa-user "></i>
                    
                    关于
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search" >
                    <i class="fa fa-search "></i>
                    
                    搜索
                </a>
            </li>
        
    </ul>

    <ul class="side-nav brown darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Android/">
                    Android <span class="right">15 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/开发技巧/">
                    开发技巧 <span class="right">5 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/技术调研/">
                    技术调研 <span class="right">4 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/源码分析/">
                    源码分析 <span class="right">2 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Java-Web/">
                    Java-Web <span class="right">3 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/OpenGL-ES/">
                    OpenGL-ES <span class="right">7 篇</span></a>
                </a>
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/自动化测试/">
                    自动化测试 <span class="right">1 篇</span></a>
                </a>
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">搜索</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper brown darken-1">
        <span class="breadcrumb">当前位置（分类目录）</span>
        
            
    
    
    <a class="breadcrumb" href="/categories/源码分析/">源码分析</a>


        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>String源码分析</h1>
    


            </div>
            <time class="light-green-link-context" datetime="2016-03-30T15:19:09.000Z"><a href="/2016/03/30/String源码分析/">2016-03-30</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            
    <div class="tags-row">
        
            <a href="/tags/Java/" class="chip light-green">Java</a>
        
    </div>


            <div class="toc light-green-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#问题的引入"><span class="section table-of-contents-text">问题的引入</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#定义"><span class="section table-of-contents-text">定义</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#属性"><span class="section table-of-contents-text">属性</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#构造方法"><span class="section table-of-contents-text">构造方法</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#Java7加入的新特性"><span class="section table-of-contents-text">Java7加入的新特性</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#其他方法"><span class="section table-of-contents-text">其他方法</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#比较方法"><span class="section table-of-contents-text">比较方法</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#hashCode"><span class="section table-of-contents-text">hashCode</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#String-对-“-”-的重载"><span class="section table-of-contents-text">String 对 “+” 的重载</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#switch对字符串支持的实现"><span class="section table-of-contents-text">switch对字符串支持的实现</span></a></li><li class="section table-of-contents-item section table-of-contents-level-2"><a class="section table-of-contents-link" href="#总结"><span class="section table-of-contents-text">总结</span></a></li></ol>
</div>


            <div class="entry light-green-link-context">
                <blockquote>
<p>笔者马上毕业了，准备开始 Java 的进阶学习计划。于是打算先从 String 类的源码分析入手，作为后面学习的案例。这篇文章寄托着今后进阶系列产出的愿望，希望能坚持下去，不忘初心，让自己保持那份对技术的热爱。</p>
</blockquote>
<p>因为学习分析源码，所以借鉴了 HollisChuang <a href="http://www.hollischuang.com/" target="_blank" rel="external">成神之路</a>的大部分内容，并在此基础上对源码进行了学习，在此感谢。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/580515-b56e704b46879cd6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="等风来"></p>
<h2 id="问题的引入"><a href="#问题的引入" class="headerlink" title="问题的引入"></a>问题的引入</h2><p>关于 String 字符串，对于 Java 开发者而言，这无疑是一个非常熟悉的类。也正是因为经常使用，其内部代码的设计才值得被深究。所谓知其然，更得知其所以然。</p>
<p>举个例子，假如想要写个类去继承 String，这时 IDE 提示 String 为final类型不允许被继承。<br><img src="http://upload-images.jianshu.io/upload_images/580515-614176e44c92da21.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>此时最先想到的肯定是 java 中类被 final 修饰的效果，其实由这一点也可以引出更多思考：<br><strong>比如说 String 类被设计成 final 类型是出于哪些考虑？</strong></p>
<blockquote>
<p>在 Java 中，被 final 类型修饰的类不允许被其他类继承，被 final 修饰的变量赋值后不允许被修改</p>
</blockquote>
<hr>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>查看 String 类在 jdk7 源码中的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">String</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>, <span class="title">Comparable</span>&lt;<span class="title">String</span>&gt;, <span class="title">CharSequence</span></span>&#123;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出 String 是 final 类型的，表示该类不能被其他类继承，同时该类实现了三个接口：<code>java.io.Serializable</code>  <code>Comparable&lt;String&gt;</code> <code>CharSequence</code></p>
<p>对于 Sting 类，官方有如下注释说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">Strings are constant; </span></div><div class="line"><span class="comment">their values can not be changed after they are created.</span></div><div class="line"><span class="comment">Stringbuffers support mutable strings.</span></div><div class="line"><span class="comment">Because String objects are immutable they can be shared. Forexample:</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<p>String 字符串是常量，其值在实例创建后就不能被修改，但字符串缓冲区支持可变的字符串，因为缓冲区里面的不可变字符串对象们可以被共享。（其实就是使对象的引用发生了改变）</p>
<hr>
<h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">The value isused for character storage.</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">char</span> value[];</div></pre></td></tr></table></figure>
<p>这是一个字符数组，并且是 final 类型，用于存储字符串内容。从 fianl 关键字可以看出，String 的内容一旦被初始化后，其不能被修改的。</p>
<p>看到这里也许会有人疑惑，String 初始化以后好像可以被修改啊。比如找一个常见的例子：<br><code>String str = “hello”;     str = “hi”</code><br>其实这里的赋值并不是对 str 内容的修改，而是将str指向了新的字符串。另外可以明确的一点：<strong>String 其实是基于字符数组 char[] 实现的。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">Cache the hashcode for the string</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> hash;  <span class="comment">//Default to 0</span></div></pre></td></tr></table></figure>
<p>缓存字符串的 hash Code，其默认值为 0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">use serialVersionUID from JDK 1.0.2 for interoperability</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6849794470754667710L</span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">Class String is special cased with in the Serialization Stream Protocol.</span></div><div class="line"><span class="comment">*/</span></div><div class="line">privates tatic <span class="keyword">final</span> ObjectStreamField[] serialPersistentFields =  <span class="keyword">new</span> ObjectStreamField[<span class="number">0</span>]</div></pre></td></tr></table></figure>
<p>因为 String 实现了 Serializable 接口，所以支持序列化和反序列化支持。Java 的序列化机制是通过在运行时判断类的 serialVersionUID 来验证版本一致性的。在进行反序列化时，JVM 会把传来的字节流中的 serialVersionUID 与本地相应实体（类）的 serialVersionUID 进行比较，如果相同就认为是一致的，可以进行反序列化，否则就会出现序列化版本不一致的异常(InvalidCastException)。</p>
<hr>
<h2 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h2><p><strong>空的构造器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">this</span>.value = <span class="string">""</span>.value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该构造方法会创建空的字符序列，注意这个构造方法的使用，因为创造不必要的字符串对象是不可变的。因此不建议采取下面的创建 String 对象:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String str = <span class="keyword">new</span> String()</div><div class="line">str = <span class="string">"sample"</span>;</div></pre></td></tr></table></figure>
<blockquote>
<p>这样的结果显而易见，会产生了不必要的对象。</p>
</blockquote>
<p><strong>使用字符串类型的对象来初始化</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(String original)</span></span>&#123;</div><div class="line">  <span class="keyword">this</span>.value = original.value;</div><div class="line">  <span class="keyword">this</span>.hash = original.hash;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里将直接将源 String 中的 value 和 hash 两个属性直接赋值给目标 String。因为 String 一旦定义之后是不可以改变的，所以也就不用担心改变源<br> String 的值会影响到目标 String 的值。</p>
<p><strong>使用字符数组来构造</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(<span class="keyword">char</span> value[])</span></span>&#123;</div><div class="line">    <span class="keyword">this</span>.value = Arrays.copyOf(value, value.length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(<span class="keyword">char</span> value[], <span class="keyword">int</span> offset, <span class="keyword">int</span> count)</span></span>&#123;</div><div class="line">  <span class="keyword">if</span>(offset&lt;<span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(offset);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span>(count&lt;=<span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">if</span>(count&lt;<span class="number">0</span>)&#123;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="function">String <span class="title">IndexOutOfBoundsException</span><span class="params">(count)</span></span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>(offset &lt;= value.length)&#123;</div><div class="line">      <span class="keyword">this</span>.value = <span class="string">""</span>.value;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line"> <span class="comment">//Note:offset or count might be near-1&gt;&gt;&gt;1.</span></div><div class="line">  <span class="keyword">if</span>(offset &gt; value.length - count)&#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(offset+count);</div><div class="line">  &#125;</div><div class="line"> <span class="keyword">this</span>.value=Arrays.copyOfRange(value,offset,offset+count);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里值得注意的是：当我们使用字符数组创建<br> String 的时候，会用到 Arrays.copyOf 方法或<br> Arrays.copyOfRange 方法。这两个方法是将原有的字符数组中的内容逐一的复制到String中的字符数组中。会创建一个新的字符串对象，随后修改的字符数组不影响新创建的字符串。</p>
<p><strong>使用字节数组来构建 String </strong></p>
<p>在 Java 中，String 实例中保存有一个 char[] 字符数组，char[] 字符数组是以 unicode 码来存储的，String 和 char 为内存形式。<br>byte 是网络传输或存储的序列化形式，所以在很多传输和存储的过程中需要将 byte[] 数组和String进行相互转化。所以，String 提供了一系列重载的构造方法来将一个字符数组转化成 String，提到 byte[] 和 String 之间的相互转换就不得不关注编码问题。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String(<span class="keyword">byte</span>[] bytes, Charset charset)</div></pre></td></tr></table></figure>
<p>该构造方法是指通过 charset 来解码指定的 byte 数组，将其解码成 unicode 的 char[] 数组，够造成新的 String。<br>这里的 bytes 字节流是使用 charset 进行编码的，想要将他转换成 unicode 的 char[] 数组，而又保证不出现乱码，那就要指定其解码方式**</p>
<p>同样使用字节数组来构造 String 也有很多种形式，按照是否指定解码方式分的话可以分为两种：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(<span class="keyword">byte</span> bytes[])</span></span>&#123;</div><div class="line">  <span class="keyword">this</span>(bytes, <span class="number">0</span>, bytes.length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(<span class="keyword">byte</span> bytes[], <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span></span>&#123;</div><div class="line">  checkBounds(bytes, offset, length);</div><div class="line">    <span class="keyword">this</span>.value = StringCoding.decode(bytes, offset, length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果我们在使用 byte[] 构造 String 的时候，使用的是下面这四种构造方法(带有 charsetName 或者<br> charset 参数)的一种的话，那么就会使用<br> StringCoding.decode 方法进行解码，使用的解码的字符集就是我们指定的 charsetName 或者<br> charset 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">String(<span class="keyword">byte</span> bytes[])</div><div class="line">String(<span class="keyword">byte</span> bytes[], <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</div><div class="line">String(<span class="keyword">byte</span> bytes[], Charset charset)</div><div class="line">String(<span class="keyword">byte</span> bytes[], String charsetName)</div><div class="line">String(<span class="keyword">byte</span> bytes[], <span class="keyword">int</span> offset, <span class="keyword">int</span> length, Charset charset)</div><div class="line">String(<span class="keyword">byte</span> bytes[], <span class="keyword">int</span> offset, <span class="keyword">int</span> length, String charsetName)</div></pre></td></tr></table></figure>
<p>们在使用 byte[] 构造 String 的时候，如果没有指明解码使用的字符集的话，那么 StringCoding 的 decode 方法首先调用系统的默认编码格式，如果没有指定编码格式则默认使用 ISO-8859-1 编码格式进行编码操作。主要体现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">char</span>[] decode(<span class="keyword">byte</span>[] ba, <span class="keyword">int</span> off, <span class="keyword">int</span> len)&#123;</div><div class="line">    String csn = Charset.defaultCharset().name();</div><div class="line">    <span class="keyword">try</span>&#123; <span class="comment">//use char set name decode() variant which provide scaching.</span></div><div class="line">         <span class="keyword">return</span> decode(csn, ba, off, len);</div><div class="line">    &#125; <span class="keyword">catch</span>(UnsupportedEncodingException x)&#123;</div><div class="line">         warnUnsupportedCharset(csn);</div><div class="line">    &#125;</div><div class="line">   </div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        <span class="keyword">return</span> decode(<span class="string">"ISO-8859-1"</span>, ba, off, len);  </div><div class="line">       &#125; <span class="keyword">catch</span>(UnsupportedEncodingException x)&#123;</div><div class="line">         <span class="comment">//If this code is hit during VM initiali zation, MessageUtils is the only way we will be able to get any kind of error message.</span></div><div class="line">       MessageUtils.err(<span class="string">"ISO-8859-1 char set not available: "</span> + x.toString());</div><div class="line">        <span class="comment">// If we can not find ISO-8859-1 (are quired encoding) then things are seriously wrong with the installation.</span></div><div class="line">       System.exit(<span class="number">1</span>);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>使用 StringBuffer 和 StringBuider 构造一个 String</strong></p>
<p>作为 String 的两个“兄弟”，StringBuffer 和 StringBuider 也可以被当做构造 String 的参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(StringBuffer buffer)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span>(buffer) &#123;</div><div class="line">    <span class="keyword">this</span>.value = Arrays.copyOf(buffer.getValue(), buffer.length());</div><div class="line">    &#125; </div><div class="line">&#125; </div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">String</span><span class="params">(StringBuilder builder)</span> </span>&#123;</div><div class="line">     <span class="keyword">this</span>.value = Arrays.copyOf(builder.getValue(), builder.length());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，这两个构造方法是很少用到的，因为当我们有了 StringBuffer 或者 StringBuilfer 对象之后可以直接使用他们的 toString 方法来得到 String。</p>
<blockquote>
<p>关于效率问题，Java 的官方文档有提到说使用 StringBuilder 的 toString 方法会更快一些，原因是 StringBuffer 的 toString 方法是 synchronized 的，在牺牲了效率的情况下保证了线程安全。</p>
</blockquote>
<p>StringBuilder 的 toString() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="comment">//Create a copy, don't share the array</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> String(value,<span class="number">0</span>,count);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>StringBuffer 的 toString() 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">if</span> (toStringCache == <span class="keyword">null</span>)&#123;</div><div class="line">    toStringCache = Arrays.copyOfRange(value, <span class="number">0</span>, count);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> String(toStringCache, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>一个特殊的保护类型的构造方法</strong></p>
<p>String 除了提供了很多公有的供程序员使用的构造方法以外，还提供了一个保护类型的构造方法（Java 7），我们看一下他是怎么样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">String(<span class="keyword">char</span>[] value, <span class="keyword">boolean</span> share) &#123;</div><div class="line"> <span class="comment">// assert share : "unshared not supported";</span></div><div class="line"> <span class="keyword">this</span>.value = value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从代码中我们可以看出，该方法和 String(char[] value) 有两点区别：</p>
<ul>
<li><p>第一个，该方法多了一个参数：boolean share，其实这个参数在方法体中根本没被使用。注释说目前不支持 false，只使用 true。<br>那可以断定，加入这个 share 的只是为了区分于 String(char[] value) 方法，不加这个参数就没办法定义这个函数，只有参数是不能才能进行重载。</p>
</li>
<li><p>第二个区别就是具体的方法实现不同。我们前面提到过，String(char[] value) 方法在创建 String 的时候会用到 Arrays 的 copyOf 方法将value中的内容逐一复制到 String当中，而这个 String(char[] value, boolean share) 方法则是直接将value的引用赋值给String的value。</p>
</li>
</ul>
<p>那么也就是说，这个方法构造出来的 String 和参数传过来的 char[] value 共享同一个数组。 </p>
<p><strong>为什么 Java 会提供这样一个方法呢？</strong></p>
<ul>
<li><strong>性能好</strong></li>
</ul>
<p>这个很简单，一个是直接给数组赋值（相当于直接将 String 的 value 的指针指向char[]数组），一个是逐一拷贝。当然是直接赋值快了。</p>
<ul>
<li><strong>节约内存</strong></li>
</ul>
<p>该方法之所以设置为 protected，是因为一旦该方法设置为公有，在外面可以访问的话，如果构造方法没有对 arr 进行拷贝，那么其他人就可以在字符串外部修改该数组，由于它们引用的是同一个数组，因此对 arr 的修改就相当于修改了字符串，那就破坏了字符串的不可变性。</p>
<ul>
<li><strong>安全的</strong></li>
</ul>
<p>对于调用他的方法来说，由于无论是原字符串还是新字符串，其 value 数组本身都是 String 对象的私有属性，从外部是无法访问的，因此对两个字符串来说都很安全。</p>
<h2 id="Java7加入的新特性"><a href="#Java7加入的新特性" class="headerlink" title="Java7加入的新特性"></a>Java7加入的新特性</h2><p>在 Java 7 之前有很多 String 里面的方法都使用上面说的那种“性能好的、节约内存的、安全”的构造函数。<br>比如：<code>substring</code> <code>replace</code> <code>concat</code> <code>valueOf</code>等方法</p>
<blockquote>
<p>实际上他们使用的是public String(char[], ture)方法来实现。</p>
</blockquote>
<p><strong>但是在 Java 7 中，substring已经不再使用这种“优秀”的方法了</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">substring</span><span class="params">(<span class="keyword">int</span> beginIndex, <span class="keyword">int</span> endIndex)</span></span>&#123;</div><div class="line">  <span class="keyword">if</span>(beginIndex &lt; <span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(beginIndex);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span>(endIndex &gt; value.length)&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(endIndex);</div><div class="line">  &#125;</div><div class="line">  intsubLen = endIndex-beginIndex;</div><div class="line">  <span class="keyword">if</span>(subLen &lt; <span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(subLen);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> ((beginIndex == <span class="number">0</span>) &amp;&amp; (endIndex == value.length)) ? <span class="keyword">this</span>  : newString(value, beginIndex, subLen);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>为什么呢？</strong><br>虽然这种方法有很多优点，但是他有一个致命的缺点，对于 sun 公司的程序员来说是一个零容忍的 bug，那就是他很有可能造成<strong>内存泄露</strong>。<br>看一个例子，假设一个方法从某个地方（文件、数据库或网络）取得了一个很长的字符串，然后对其进行解析并提取其中的一小段内容，这种情况经常发生在网页抓取或进行日志分析的时候。<br>下面是示例代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">String aLongString = <span class="string">"...averylongstring..."</span>;</div><div class="line">StringaPart = data.substring(<span class="number">20</span>, <span class="number">40</span>);</div><div class="line"><span class="keyword">return</span> aPart;</div></pre></td></tr></table></figure>
<p>在这里 aLongString 只是临时的，真正有用的是 aPart，其长度只有 20 个字符，但是它的内部数组却是从 aLongString 那里共享的，因此虽然 aLongString 本身可以被回收，但它的内部数组却不能释放。这就导致了内存泄漏。如果一个程序中这种情况经常发生有可能会导致严重的后果，如内存溢出，或性能下降。</p>
<blockquote>
<p>新的实现虽然损失了性能，而且浪费了一些存储空间，但却保证了字符串的内部数组可以和字符串对象一起被回收，从而防止发生内存泄漏，因此新的 substring 比原来的更健壮。</p>
</blockquote>
<h2 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h2><p>length() 返回字符串长度</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">length</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">return</span> value.length;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>isEmpty() 返回字符串是否为空</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">return</span> value.length == <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>charAt(int index)  返回字符串中第（index+1）个字符（数组索引）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">charAt</span><span class="params">(<span class="keyword">int</span> index)</span></span>&#123;</div><div class="line">  <span class="keyword">if</span>((index &lt; <span class="number">0</span>) || (index &gt;= value.length))&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(index);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> value[index];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>char[] toCharArray() 转化成字符数组<br>trim() 去掉两端空格<br>toUpperCase() 转化为大写<br>toLowerCase() 转化为小写</p>
<p><strong>需要注意</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function">String <span class="title">concat</span><span class="params">(String str)</span> <span class="comment">//拼接字符串</span></span></div><div class="line"><span class="function">String <span class="title">replace</span><span class="params">(<span class="keyword">char</span> oldChar, <span class="keyword">char</span> newChar)</span> <span class="comment">//将字符串中的oldChar字符换成 newChar 字符</span></span></div></pre></td></tr></table></figure>
<blockquote>
<p>以上两个方法都使用了String(char[] value, boolean share)；concat 方法和 replace 方法，他们不会导致元数组中有大量空间不被使用，因为他们一个是拼接字符串，一个是替换字符串内容，不会将字符数组的长度变得很短，所以使用了共享的<br> char[] 字符数组来优化。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String regex)</span> <span class="comment">//判断字符串是否匹配给定的regex正则表达式</span></span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(CharSequence s)</span> <span class="comment">//判断字符串是否包含字符序列 s</span></span></div><div class="line"><span class="function">String[] <span class="title">split</span><span class="params">(String regex, <span class="keyword">int</span> limit)</span> 按照字符 regex将字符串分成 limit 份</span></div><div class="line"><span class="function">String[] <span class="title">split</span><span class="params">(String regex)</span> 按照字符 regex 将字符串分段</span></div></pre></td></tr></table></figure>
<p><strong>getBytes</strong></p>
<p>在创建 String 的时候，可以使用 byte[] 数组，将一个字节数组转换成字符串，同样，我们可以将一个字符串转换成字节数组，那么 String 提供了很多重载的 getBytes 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getBytes()&#123;</div><div class="line">  <span class="keyword">return</span> StringCoding.encode(value, <span class="number">0</span>, value.length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但是，值得注意的是，在使用这些方法的时候一定要注意编码问题。比如：</p>
<p><code>String s = &quot;你好，世界！&quot;; byte[] bytes = s.getBytes();</code></p>
<p>这段代码在不同的平台上运行得到结果是不一样的。由于没有指定编码方式，所以在该方法对字符串进行编码的时候就会使用系统的默认编码方式。</p>
<blockquote>
<p>在中文操作系统中可能会使用 GBK 或者 GB2312 进行编码，在英文操作系统中有可能使用 iso-8859-1 进行编码。这样写出来的代码就和机器环境有很强的关联性了，为了避免不必要的麻烦，要指定编码方式。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] getBytes(String charsetName) <span class="keyword">throws</span> UnsupportedEncodingException&#123;</div><div class="line">  <span class="keyword">if</span> (charsetName == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">  <span class="keyword">return</span> StringCoding.encode(charsetName, value, <span class="number">0</span>, value.length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="比较方法"><a href="#比较方法" class="headerlink" title="比较方法"></a>比较方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object anObject)</span>；</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">contentEquals</span><span class="params">(String Buffersb)</span>；</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">contentEquals</span><span class="params">(Char Sequencecs)</span>；</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">equalsIgnoreCase</span><span class="params">(String anotherString)</span>；</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(String anotherString)</span>；</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">compareToIgnoreCase</span><span class="params">(String str)</span>；</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">regionMatches</span><span class="params">(<span class="keyword">int</span> toffset, String other, <span class="keyword">int</span> ooffset, <span class="keyword">int</span> len)</span> <span class="comment">//局部匹配</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">regionMatches</span><span class="params">(<span class="keyword">boolean</span> ignoreCase, <span class="keyword">int</span> toffset, String other, <span class="keyword">int</span> ooffset, <span class="keyword">int</span> len)</span> <span class="comment">//局部匹配</span></span></div></pre></td></tr></table></figure>
<p>字符串有一系列方法用于比较两个字符串的关系。 前四个返回 boolean 的方法很容易理解，前三个比较就是比较 String 和要比较的目标对象的字符数组的内容，一样就返回true, 不一样就返回false，核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> n = value.length; </div><div class="line"><span class="keyword">while</span> (n-- ! = <span class="number">0</span>) &#123;</div><div class="line">   <span class="keyword">if</span> (v1[i] != v2[i])</div><div class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">     i++;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>v1 v2 分别代表 String 的字符数组和目标对象的字符数组。 第四个和前三个唯一的区别就是他会将两个字符数组的内容都使用 toUpperCase 方法转换成大写再进行比较，以此来忽略大小写进行比较。相同则返回 true，不想同则返回 false</p>
</blockquote>
<p><strong>equals方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object anObject)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (<span class="keyword">this</span> == anObject) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">     &#125; </div><div class="line">    <span class="keyword">if</span> (anObject <span class="keyword">instanceof</span> String) &#123;</div><div class="line">       String anotherString = (String) anObject;</div><div class="line">       <span class="keyword">int</span> n = value.length;</div><div class="line">       <span class="keyword">if</span> (n == anotherString.value.length) &#123;</div><div class="line">           <span class="keyword">char</span> v1[] = value;</div><div class="line">           <span class="keyword">char</span> v2[] = anotherString.value;</div><div class="line">           <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">           <span class="keyword">while</span> (n-- != <span class="number">0</span>) &#123;</div><div class="line">             <span class="keyword">if</span> (v1[i] != v2[i])</div><div class="line">             <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">             i++;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125; </div><div class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法首先判断this == anObject ？，也就是说判断要比较的对象和当前对象是不是同一个对象，如果是直接返回 true，如不是再继续比较，然后在判断<br> anObject 是不是 String<br>类型的，如果不是，直接返回 false，如果是再继续比较，到了能终于比较字符数组的时候，他还是先比较了两个数组的长度，不一样直接返回 false，一样再逐一比较值。 虽然代码写的内容比较多，但是可以很大程度上提高比较的效率。值得学习！！！</p>
<p>contentEquals 有两个重载:<br>StringBuffer 需要考虑线程安全问题，加锁之后再调用 contentEquals((CharSequence) sb) 方法。<br>contentEquals((CharSequence) sb) 则分两种情况，一种是 <code>cs instanceof AbstractStringBuilder</code>，另外一种是参数是 String 类型。具体比较方式几乎和 equals 方法类似，先做“宏观”比较，在做“微观”比较。</p>
<p>下面这个是equalsIgnoreCase代码的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equalsIgnoreCase</span><span class="params">(String anotherString)</span> </span>&#123;</div><div class="line"><span class="keyword">return</span> (<span class="keyword">this</span> == anotherString) ? <span class="keyword">true</span> : (anotherString != <span class="keyword">null</span>) &amp;&amp; (anotherString.value.length == value.length) &amp;&amp; regionMatches(<span class="keyword">true</span>, <span class="number">0</span>, anotherString, <span class="number">0</span>, value.length);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到这段代码，眼前为之一亮。使用一个三目运算符和&amp;&amp;操作代替了多个 if 语句。</p>
<h2 id="hashCode"><a href="#hashCode" class="headerlink" title="hashCode"></a>hashCode</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>&#123;</div><div class="line">  <span class="keyword">int</span> h = hash;</div><div class="line">  <span class="keyword">if</span>(h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">char</span> val[] = value;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; value.length; i++)&#123;</div><div class="line">      h = <span class="number">31</span> * h + val[i];</div><div class="line">    &#125;</div><div class="line">    hash = h;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> h;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>hashCode 的实现其实就是使用数学公式：s[0]<em>31^(n-1) + s[1]</em>31^(n-2) + … + s[n-1]</p>
</blockquote>
<p>所谓“冲突”，就是在存储数据计算hash地址的时候，我们希望尽量减少有同样的hash地址。如果使用相同 hash 地址的数据过多，那么这些数据所组成的 hash 链就更长，从而降低了查询效率。<br>所以在选择系数的时候要选择尽量长的系数并且让乘法尽量不要溢出的系数，因为如果计算出来的 hash 地址越大，所谓的“冲突”就越少，查找起来效率也会提高。</p>
<blockquote>
<p>现在很多虚拟机里面都有做相关优化，使用 31 的原因可能是为了更好的分配 hash 地址，并且 31 只占用 5 bits。</p>
</blockquote>
<p>在 Java 中，整型数是 32 位的，也就是说最多有2^32 = 4294967296 个整数，将任意一个字符串，经过 hashCode 计算之后，得到的整数应该在这 4294967296 数之中。那么，最多有 4294967297 个不同的字符串作 hashCode 之后，肯定有两个结果是一样的。</p>
<blockquote>
<p>hashCode 可以保证相同的字符串的 hash 值肯定相同，但是 hash 值相同并不一定是 value 值就相同。</p>
</blockquote>
<p><strong>substring</strong><br>前面我们介绍过，java 7 中的 substring 方法使用 String(value, beginIndex, subLen) 方法创建一个新的 String 并返回，这个方法会将原来的 char[] 中的值逐一复制到新的 String 中，两个数组并不是共享的，虽然这样做损失一些性能，但是有效地避免了内存泄露。</p>
<p><strong>replaceFirst、replaceAll、replace区别</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">String <span class="title">replaceFirst</span><span class="params">(String regex, String replacement)</span></span></div><div class="line"><span class="function">String <span class="title">replaceAll</span><span class="params">(String regex, String replacement)</span></span></div><div class="line"><span class="function">String <span class="title">replace</span><span class="params">(Char Sequencetarget, Char Sequencereplacement)</span></span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">replace</span><span class="params">(<span class="keyword">char</span> oldChar, <span class="keyword">char</span> newChar)</span></span>&#123;</div><div class="line">  <span class="keyword">if</span>(oldChar != newChar)&#123;</div><div class="line">    <span class="keyword">int</span> len = value.length;</div><div class="line">    <span class="keyword">int</span> i = -<span class="number">1</span>;</div><div class="line">    <span class="keyword">char</span>[] val = value; <span class="comment">/*avoid get field opcode*/</span></div><div class="line">    <span class="keyword">while</span> (++i &lt; len)&#123;</div><div class="line">      <span class="keyword">if</span> (val[i] == oldChar)&#123;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span>( i &lt; len )&#123;</div><div class="line">      <span class="keyword">char</span> buf[] = <span class="keyword">new</span> <span class="keyword">char</span>[len];</div><div class="line">      <span class="keyword">for</span> (intj=<span class="number">0</span>; j&lt;i; j++)&#123;</div><div class="line">        buf[j] = val[j];</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">while</span> (i &lt; len)&#123;</div><div class="line">        <span class="keyword">char</span> c = val[i];</div><div class="line">        buf[i] = (c == oldChar) ? newChar : c;</div><div class="line">        i++;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">new</span> String(buf,<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">   &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>replace 的参数是 char 和 CharSequence，即可以支持字符的替换, 也支持字符串的替换</li>
<li>replaceAll 和 replaceFirst 的参数是 regex，即基于规则表达式的替换</li>
</ul>
<blockquote>
<p>比如可以通过 replaceAll (“\d”, “*”)把一个字符串所有的数字字符都换成星号;</p>
</blockquote>
<p>相同点是都是全部替换，即把源字符串中的某一字符或字符串全部换成指定的字符或字符串，如果只想替换第一次出现的，可以使用 replaceFirst()，这个方法也是基于规则表达式的替换。另外,如果replaceAll() 和r eplaceFirst() 所用的参数据不是基于规则表达式的，则与replace()替换字符串的效果是一样的，即这两者也支持字符串的操作。</p>
<p><strong>copyValueOf 和 valueOf</strong><br>String的底层是由char[]实现的，早期的String构造器的实现呢，不会拷贝数组的，直接将参数的char[]数组作为String的value属性。字符数组将导致字符串的变化。<br>为了避免这个问题，提供了copyValueOf方法，每次都拷贝成新的字符数组来构造新的String对象。</p>
<blockquote>
<p>现在的String对象，在构造器中就通过拷贝新数组实现了，所以这两个方面在本质上已经没区别了。</p>
</blockquote>
<p>valueOf()有很多种形式的重载，包括：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">valueOf</span><span class="params">(<span class="keyword">boolean</span> b)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> b ? <span class="string">"true"</span> : <span class="string">"false"</span>;</div><div class="line"> &#125; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">valueOf</span><span class="params">(<span class="keyword">char</span> c)</span> </span>&#123;</div><div class="line">       <span class="keyword">char</span> data[] = &#123;c&#125;;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> String(data, <span class="keyword">true</span>);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">valueOf</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> Integer.toString(i);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">valueOf</span><span class="params">(<span class="keyword">long</span> l)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> Long.toString(l);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">valueOf</span><span class="params">(<span class="keyword">float</span> f)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> Float.toString(f);</div><div class="line"> &#125; </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">valueOf</span><span class="params">(<span class="keyword">double</span> d)</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> Double.toString(d);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到这些方法可以将六种基本数据类型的变量转换成String类型。</p>
<p><strong>intern()方法</strong><br><code>public native String intern();</code> 该方法返回一个字符串对象的内部化引用。</p>
<p>String类维护一个初始为空的字符串的对象池，当intern方法被调用时，如果对象池中已经包含这一个相等的字符串对象则返回对象池中的实例，否则添加字符串到对象池并返回该字符串的引用。</p>
<h2 id="String-对-“-”-的重载"><a href="#String-对-“-”-的重载" class="headerlink" title="String 对 “+” 的重载"></a>String 对 “+” 的重载</h2><p>我们知道，Java 是不支持重载运算符，String 的 “+” 是 java 中唯一的一个重载运算符，那么 java 使如何实现这个加号的呢？我们先看一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">     String string=<span class="string">"hollis"</span>;</div><div class="line">     String string2 = string + <span class="string">"chuang"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后我们将这段代码的实际执行情况：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</div><div class="line">     String string = <span class="string">"hollis"</span>;</div><div class="line">     String string2 = (<span class="keyword">new</span>         </div><div class="line">     StringBuilder(String.valueOf(string))).append(<span class="string">"chuang"</span>).toString();</div><div class="line">&#125;</div><div class="line"></div><div class="line">```kava</div><div class="line">看了反编译之后的代码我们发现，其实String对“+”的支持其实就是使用了StringBuilder以及他的append、toString两个方法。</div><div class="line"></div><div class="line">**String.valueOf和Integer.toString的区别**</div><div class="line"></div><div class="line">接下来我们看以下这段代码，我们有三种方式将一个<span class="keyword">int</span>类型的变量变成呢过String类型，那么他们有什么区别？</div><div class="line"></div><div class="line">```java</div><div class="line"><span class="keyword">int</span> i = <span class="number">5</span>;</div><div class="line">String i1 = <span class="string">""</span> + i;</div><div class="line">String i2 = String.valueOf(i);</div><div class="line">String i3 = Integer.toString(i);</div></pre></td></tr></table></figure>
<p>第三行和第四行没有任何区别，因为String.valueOf(i)也是调用Integer.toString(i)来实现的。<br>第二行代码其实是 <code>String i1 = (new StringBuilder()).append(i).toString();</code></p>
<blockquote>
<p>首先创建了一个StringBuilder对象，然后再调用append方法，再调用toString方法。</p>
</blockquote>
<hr>
<h2 id="switch对字符串支持的实现"><a href="#switch对字符串支持的实现" class="headerlink" title="switch对字符串支持的实现"></a>switch对字符串支持的实现</h2><p>还是先上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">switchDemoString</span> </span>&#123;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">         String str = <span class="string">"world"</span>;</div><div class="line">         <span class="keyword">switch</span> (str) &#123;</div><div class="line">         <span class="keyword">case</span> <span class="string">"hello"</span>: </div><div class="line">              System.out.println(<span class="string">"hello"</span>);</div><div class="line">              <span class="keyword">break</span>;</div><div class="line">         <span class="keyword">case</span> <span class="string">"world"</span>:</div><div class="line">             System.out.println(<span class="string">"world"</span>);</div><div class="line">             <span class="keyword">break</span>;</div><div class="line">         <span class="keyword">default</span>: <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对编译后的代码进行反编译：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line">       String str = <span class="string">"world"</span>;</div><div class="line">       String s;</div><div class="line">       <span class="keyword">switch</span>((s = str).hashCode()) &#123;</div><div class="line">          <span class="keyword">case</span> <span class="number">99162322</span>:</div><div class="line">               <span class="keyword">if</span>(s.equals(<span class="string">"hello"</span>))</div><div class="line">                   System.out.println(<span class="string">"hello"</span>);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">          <span class="keyword">case</span> <span class="number">113318802</span>:</div><div class="line">               <span class="keyword">if</span>(s.equals(<span class="string">"world"</span>))</div><div class="line">                   System.out.println(<span class="string">"world"</span>);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">          <span class="keyword">default</span>: <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>看到这个代码，你知道原来字符串的 switch 是通过 equals() 和 hashCode() 方法来实现的。记住，switch 中只能使用整型，比如byte，short，char(ackii 码是整型)以及 int。还好 hashCode() 方法返回的是 int 而不是 long。</p>
<blockquote>
<p>通过这个很容易记住 hashCode 返回的是 int 这个事实。仔细看下可以发现，进行 switch 的实际是哈希值，然后通过使用 equals 方法比较进行安全检查，这个检查是必要的，因为哈希可能会发生碰撞。</p>
</blockquote>
<p>因此性能是不如使用枚举进行switch或者使用纯整数常量，但这也不是很差。因为 Java 编译器只增加了一个 equals 方法，如果你比较的是字符串字面量的话会非常快，比如 ”abc” ==”abc”。如果你把 hashCode() 方法的调用也考虑进来了，那么还会再多一次的调用开销，因为字符串一旦创建了，它就会把哈希值缓存起来。</p>
<p>因此如果这个 siwtch 语句是用在一个循环里的，比如逐项处理某个值，或者游戏引擎循环地渲染屏幕，这里 hashCode() 方法的调用开销其实不会很大。</p>
<blockquote>
<p>其实 swich 只支持一种数据类型，那就是整型，其他数据类型都是转换成整型之后在使用switch的。</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p>一旦 string 对象在内存(堆)中被创建出来，就无法被修改。特别要注意的是，String 类的所有方法都没有改变字符串本身的值，都是返回了一个新的对象。</p>
</li>
<li><p>如果你需要一个可修改的字符串，应该使用 StringBuffer 或者 StringBuilder。否则会有大量时间浪费在垃圾回收上，因为每次试图修改都有新的string对象被创建出来。</p>
</li>
<li><p>如果你只需要创建一个字符串，你可以使用双引号的方式，如果你需要在堆中创建一个新的对象，你可以选择构造函数的方式。</p>
</li>
</ul>

                
<p class="light-green-link-context">
    <a href="/2016/04/13/Android反编译后重新打包/" rel="next" title="Android反编译后重新打包">
    上一篇：Android反编译后重新打包
  </a>
</p>



<p class="light-green-link-context">
    <a href="/2016/03/06/Android程序员的技术要求和学习路线/" rel="next" title="Android程序员的技术要求和学习路线">
    下一篇：Android程序员的技术要求和学习路线
  </a>
</p>


            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large light-green">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect red" title="回到顶部"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse purple"  data-activates="main-menu" title="菜单"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer brown darken-1 darken-1">
    
    <div class="footer-container container">
        <div class="row">
            
            <div class="social-group col m4 s12">
                <h5 class="white-text">社交</h5>
                
                    <a class="social-link" href="http://weibo.com/2924419940/profile?topnav=1&amp;wvr=6&amp;is_all=1" target="_blank">
                        <i class="fa fa-2x fa-weibo"></i>
                    </a>
                
                    <a class="social-link" href="https://github.com/baishixian" target="_blank">
                        <i class="fa fa-2x fa-github"></i>
                    </a>
                
                    <a class="social-link" href="/atom.xml" target="_blank">
                        <i class="fa fa-2x fa-rss"></i>
                    </a>
                
                
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
    </script>
    <div class="site-visitors-container white-text">
        <span>
            <i class="fa fa-user"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
        </span>
        <span>&nbsp;|&nbsp;</span>
        <span>
            <i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
        </span>
    </div>


            </div>
            

            
            <div class="col m8 s12">
                <h5 class="white-text">友情链接</h5>
                
                    <a class="social-link" href="http://www.jianshu.com/users/071e495a9ba2/latest_articles" target="_blank">简书</a>
                
                    <a class="social-link" href="https://github.com/baishixian" target="_blank">Github地址</a>
                
            </div>
            
        </div>
    </div>
    

    <div class="footer-copyright light-green-link-context">
        <div class="container">
            © 2017 baishixian.top, All rights reserved.
            <p class="right" style="margin-top: 0;">本博客由 <a href="https://hexo.io">Hexo</a> 强力驱动 | 主题 <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('light-green lighten-2');

            
            // 添加new标签
            $('.menu-reading, .menu-about').append('<span class="new badge light-green"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword light-green lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword light-green lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>




<script type="text/javascript" src="http://tajs.qq.com/stats?sId=55708612" charset="UTF-8"></script>




//前面要添加的代码  
<script type="text/javascript">//百度链接收录自动推送 
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
//后面要添加的  


</body>
</html>
